---
title: "SA_analysis_roll"
author: "Sarah Hvid Andersen"
date: "17/5/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

pacman::p_load(tidyverse,
               lme4,
               stats)

library(dplyr)
library(ggplot2)
library(caret)
library(ggthemes)
```


```{r}
df <- read_csv("abm_roll_eval.csv")
folkeskolen <- read.csv("folkeskolen_stats.csv")

df_big <- df %>% filter(NumberOfStudents >= 20)
df_big$Knowledge_percent <-  ((df_big$End_knowledge / df_big$Ticks) * df_big$End_knowledge) / max(df_big$End_knowledge)


df_small <- df %>% filter(NumberOfStudents <= 15)
df_small$Knowledge_percent <- ((df_small$End_knowledge / df_small$Ticks) * df_small$End_knowledge) / max(df_small$End_knowledge)

df_new <- rbind(df_big, df_small) 
df <- df_new

df <- df %>% mutate(Version = as.factor(Version),
                    NumberOfStudents = as.factor(NumberOfStudents),
                    Ticks = as.factor(Ticks),
                    ID = as.factor(ID))

```


```{r}
#############  sensitivity function from random dude
sensitivityAnalysis <- function(model,
                                target = NULL,
                                predictors = NULL, #Data Frame
                                predictorsMeans = NULL, #Data Frame
                                samplesN = 101,
                                from = 0.6,
                                to = 1.4,
                                targetPrediction = "ratio", # c("ratio", "absolute")
                                predictionType = "prediction",
                                level = 0.9) {
    
    if (missing(target)) {
        predictors <- model$model[-1]
        target <- model$model[1]
    }
    targetName <- names(target)
    
    target <- target[[1]]
    
    numberPredictors <- ncol(predictors)     
    
    if (missing(predictorsMeans)) {
        initialPredictorsValues <- predictors %>%
            summarise_all(mean)
        
    } else {
        initialPredictorsValues <- predictorsMeans    
    }
    
    initialTargetValue <- mean(predict(model, newdata = initialPredictorsValues))
    
    sensitivityData <- sapply(initialPredictorsValues, function(x) rep(x, samplesN * numberPredictors))
    changeDF <- seq(from, to, length.out = samplesN)
    
    for (i in seq(1, numberPredictors)) {
        sensitivityData[seq((i-1)*samplesN + 1, i * samplesN), i] <- changeDF * initialPredictorsValues[[i]]    
    }
    sensitivityData <- data.frame(sensitivityData)
    
    predictedTarget <- predict(model,
                               newdata = sensitivityData,
                               interval = predictionType,
                               level = level)
    
    predictedTarget <- as.data.frame(predictedTarget)
    
    if (targetPrediction == "ratio")
        predictedTarget <- mutate_all(predictedTarget, function(x) {x / initialTargetValue})
    
    df <- data.frame(normalized.predictor.change = numeric(0),
                     predictor = character(0),
                     normalized.target.change.fit = numeric(0),
                     normalized.target.change.lower= numeric(0),
                     normalized.target.change.upper = numeric(0)) 
    
    for (i in seq(1, numberPredictors)) {
        df <- rbind(df, 
                    data.frame(
                        normalized.predictor.change = changeDF,
                        predictor = names(predictors)[i],
                        normalized.target.change.fit = predictedTarget$fit[seq((i-1)*samplesN + 1, i * samplesN)],
                        normalized.target.change.lower = predictedTarget$lwr[seq((i-1)*samplesN + 1, i * samplesN)],
                        normalized.target.change.upper = predictedTarget$upr[seq((i-1)*samplesN + 1, i * samplesN)]))
    }
    if (targetPrediction == "ratio") {
        gg <- ggplot(df, aes(x = normalized.predictor.change, 
                             group = predictor)) +
            geom_ribbon(aes(ymin = normalized.target.change.lower,
                            ymax = normalized.target.change.upper,
                            fill = predictor), alpha = 0.1) + 
            geom_vline(xintercept = 1,  color = "grey80") + 
            geom_hline(yintercept = 1, color = "grey80") +
            geom_abline(slope = 1, linetype = "dashed", color = "grey80") + 
            geom_abline(slope = -1, intercept = 2, linetype = "dashed", color = "grey80") +
            geom_line(aes(x = normalized.predictor.change,
                          y = normalized.target.change.fit,
                          color = predictor)) +
            ylab(paste("Normalized", targetName, "change")) +
            xlab("Normalized Predictor Change") + 
            theme_few()
    } else {
        gg <- ggplot(df, aes(x = normalized.predictor.change, 
                             group = predictor)) +
            geom_ribbon(aes(ymin = normalized.target.change.lower,
                            ymax = normalized.target.change.upper,
                            fill = predictor), alpha = 0.1) + 
            geom_vline(xintercept = 1,  color = "grey80") + 
            geom_hline(yintercept = initialTargetValue, color = "grey80") +
            geom_line(aes(x = normalized.predictor.change,
                          y = normalized.target.change.fit,
                          color = predictor)) +
            ylab(targetName) + 
            xlab("Normalized Predictor Change") + 
            theme_few()        
    }
    
    variableMeans <- cbind(data.frame(target = initialTargetValue),
                           data.frame(initialPredictorsValues))
    names(variableMeans) <- c(targetName, names(initialPredictorsValues))
    return(list(ggplot = gg,
                predictionData = sensitivityData,
                resultsData = df,
                variableMeans = variableMeans))
}

```


```{r}

cv_function <- function(n) {
  cv = sd(n) / mean(n)
  
  return(cv)
}

cv_function(df$Knowledge_percent)

m1 <- lm(Knowledge_Tick ~ Better_roll + Worse_roll + NumberOfStudents + Baseline.attention , df)
m2 <- lm(Grade_kt ~ Better_roll + Worse_roll + NumberOfStudents + Baseline.attention , df)

summary(m1)
summary(m2)

results <- sensitivityAnalysis(m2, level = 0.9, predictionType = "prediction", targetPrediction = "raw")
plot(results$ggplot)
results$variableMeans
```



plots 

```{r}

#Plotting knowledge percent 
df %>% 
  ggplot(aes(x = Knowledge_percent, y = NumberOfStudents, color = Knowledge_percent)) + 
  geom_jitter() +
  facet_grid(Better_roll ~ Worse_roll) +
  ggtitle("Parameter space for better/worse roll")



# nice comparison plot
df %>% ggplot(aes(x = Knowledge_percent)) +
  geom_histogram(bins = 20) +
  facet_grid(Better_roll ~ Worse_roll) +
  ggtitle("Parameter space for better/worse roll") +
  labs(x = 'Knowledge percent', y = '') +
  theme(
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())



df %>% ggplot(aes(x = Knowledge_percent, y = Baseline.attention)) +
  geom_point(aes(color = Version)) +
  facet_grid(Better_roll ~ Worse_roll) +
  


```

sensitivity analysis part 2

```{r}
df <- read_csv('data_csv/roll_eval2.csv')


# nice comparison plot
df %>% ggplot(aes(x = Knowledge_Tick)) +
  geom_histogram(bins = 20) +
  facet_grid(Better_roll ~ Worse_roll) +
  ggtitle("Parameter space for better/worse roll") +
  labs(x = 'Knowledge pr tick', y = '') +
  theme(
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())



df %>% ggplot(aes(x = Grade_kt)) +
  geom_histogram(bins = 20) +
  facet_grid(Better_roll ~ Worse_roll) +
  ggtitle("Parameter space for better/worse roll") +
  labs(x = 'grade', y = '') +
  theme(
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())


# we go with 1.35 and 0.8 as this distribution approximates the real one the most. 

```

