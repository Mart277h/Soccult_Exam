---
title: "clean_data"
author: "Sarah Hvid Andersen"
date: "13/5/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
pacman::p_load(tidyverse, 
               fs, 
               purrr)

```


the data is in the folder students_output. we need to read in the data from each csv file within. 

```{r}

read_data <- function(filename) {
    # getting filenames and subsetting the relevant parts
    files = path_file(path = filename) 
    
    for (file in filename){
    Date = substr(files, 7, 16)
    Version = substr(files, 18, 30)
    }
    
    # creating dataframes, loading data and merging the df's
    df = data_frame(Date, Version)
    df1 = read.csv(filename)
    data = merge(df, df1)
    
    #depending on how many files we want in the same df, we need to make the ID's unique
    data$id <- paste0(data$Version, data$ID)
    
    # cleaning the variables
    data = data %>% mutate(
        id = as.factor(id),
        NumberOfStudents = as.factor(NumberOfStudents)
        )
    
    
    return(data)
}

# testing on one file
test_data = read_data("Students_output/output2021-05-13_171337-0.csv")
    #it works

# now we can apply it to the files we want to collect into one datafram
df_1 <- list.files(path = 'data_abm_output/students_output_2nd_roll_eval/', pattern = '.csv', all.files = T, full.names = T) %>% 
    purrr::map_df(read_data)

#correcting ID now that it is one big df
  # there should always be as many Id's as observations in the dataframe
df <- df_1 %>%
  select(-ID) %>% 
  dplyr::rename(ID = id) %>% 
  mutate(
  ID = as.numeric(ID)) %>% 
  mutate(
  ID = as.factor(ID))



# correct the knowledge calculation so that we have scaled knowledge and grades
  

df$Knowledge_percent <-  df$End_knowledge / max(df$End_knowledge)


# save the full dataset as a csv file
#write_csv(df, 'roll_eval2.csv')
```

